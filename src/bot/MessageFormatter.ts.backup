import { Alert } from '@/types';
import { airpo🗓️ \`/monthlyalert ORIGEN DESTINO PRECIO [MES]\` - Alerta mensual automática (Arajet)
📋 \`/myalerts\` - Ver mis alertass } from '@/config';

/**
 * Formateador de mensajes para el bot
 */
export class MessageFormatter {
  /**
   * Mensaje de bienvenida
   */
  formatWelcomeMessage(name?: string): string {
    const greeting = name ? `¡Hola ${name}!` : '¡Hola!';
    
    return `${greeting} 👋

🚁 *Bienvenido al Bot de Monitoreo de Vuelos*

Te ayudo a encontrar las mejores ofertas de vuelos y te notifico cuando los precios bajen.

*¿Qué puedo hacer por ti?*
✈️ Crear alertas de precios
📊 Monitorear precios constantemente  
📱 Notificarte al instante
📈 Mostrar tendencias de precios
🔍 Buscar vuelos disponibles

*Para empezar:*
Usa /alert ORIGEN DESTINO PRECIO

*Ejemplo:*
\`/alert BOG MIA 800000\`
(Alerta para vuelos Bogotá → Miami bajo $800.000 COP)

¡Comencemos a ahorrar en tus viajes! ✈️💰`;
  }

  /**
   * Mensaje de ayuda general
   */
  formatHelpMessage(): string {
    return `🆘 *Ayuda - Bot de Monitoreo de Vuelos*

*Comandos Principales:*

📝 \`/start\` - Iniciar y registrarse
❓ \`/help\` - Ver esta ayuda
✈️ \`/alert ORIGEN DESTINO PRECIO\` - Crear alerta
�️ \`/monthlyalert ORIGEN DESTINO PRECIO\` - Alerta mensual automática (Arajet)
�📋 \`/myalerts\` - Ver mis alertas
⏸️ \`/stop ID\` - Pausar alerta específica
🗑️ \`/clearall\` - Eliminar todas las alertas
🔍 \`/search ORIGEN DESTINO\` - Buscar vuelos

*Códigos de Aeropuertos Principales:*
🇨🇴 BOG (Bogotá), MDE (Medellín), CTG (Cartagena)
🇺🇸 MIA (Miami), JFK (Nueva York)
🇪🇸 MAD (Madrid)
🇵🇪 LIM (Lima)

*Ejemplo de Uso:*
\`/alert BOG MIA 850000\`
Te notificaré cuando encuentre vuelos Bogotá→Miami por menos de $850.000 COP

¿Necesitas más ayuda? Usa los botones de abajo 👇`;
  }

  /**
   * Mensaje de uso de comando /alert
   */
  formatAlertUsageMessage(): string {
    return `❌ *Uso incorrecto del comando /alert*

*Formato correcto:*
\`/alert ORIGEN DESTINO PRECIO_MÁXIMO\`

*Ejemplos:*
• \`/alert BOG MIA 800000\` - Bogotá → Miami bajo $800.000
• \`/alert MDE MAD 2500000\` - Medellín → Madrid bajo $2.500.000
• \`/alert CTG LIM 400000\` - Cartagena → Lima bajo $400.000

*Códigos de aeropuertos disponibles:*
🇨🇴 BOG, MDE, CTG, CLO, BAQ, SMR, BGA, PEI
🌎 MIA, JFK, MAD, LIM, UIO, PTY

💡 *Tip:* El precio debe ser en pesos colombianos (COP) sin puntos ni comas.`;
  }

  /**
   * Mensaje de alerta creada exitosamente
   */
  formatAlertCreatedMessage(alert: Alert): string {
    const originAirport = airports[alert.origin as keyof typeof airports];
    const destinationAirport = airports[alert.destination as keyof typeof airports];

    return `✅ *¡Alerta Creada Exitosamente!*

🛫 *Ruta:* ${originAirport?.city || alert.origin} → ${destinationAirport?.city || alert.destination}
💰 *Precio máximo:* $${alert.maxPrice.toLocaleString('es-CO')} COP
📅 *Creada:* ${alert.createdAt.toLocaleDateString('es-CO')}
🆔 *ID:* ${alert.id}

🔔 *Te notificaré cuando:*
• Encuentre vuelos por debajo de tu precio máximo
• Haya cambios significativos en los precios
• Aparezcan ofertas especiales

⚡ *El monitoreo está activo las 24/7*

Usa /myalerts para ver todas tus alertas activas.`;
  }

  /**
   * Mensaje de mis alertas
   */
  formatMyAlertsMessage(alerts: Alert[]): string {
    let message = `📋 *Mis Alertas Activas* (${alerts.length})\n\n`;

    alerts.forEach((alert, index) => {
      const originAirport = airports[alert.origin as keyof typeof airports];
      const destinationAirport = airports[alert.destination as keyof typeof airports];
      
      const lastChecked = alert.lastChecked 
        ? `Última verificación: ${alert.lastChecked.toLocaleString('es-CO')}`
        : 'Pendiente primera verificación';

      message += `*${index + 1}.* ${alert.origin} → ${alert.destination}\n`;
      message += `   🏙️ ${originAirport?.city || alert.origin} → ${destinationAirport?.city || alert.destination}\n`;
      message += `   💰 Máximo: $${this._formatPrice(alert.maxPrice)} COP\n`;
      message += `   📊 Notificaciones enviadas: ${alert.notificationCount}\n`;
      message += `   🆔 ID: ${alert.id}\n`;
      message += `   ⏰ ${lastChecked}\n\n`;
    });

    message += `💡 *Tip:* Usa /stop ID para pausar una alerta específica`;

    return message;
  }

  /**
   * Notificación de alerta de precio bajo
   */
  formatAlertNotification(alertData: any): string {
    return `🚨 *¡ALERTA DE PRECIO BAJO!*

✈️ *Vuelo Encontrado:*
🛫 ${alertData.origin} → ${alertData.destination}
🏢 *Aerolínea:* ${alertData.airline}
✈️ *Vuelo:* ${alertData.flightNumber}

💰 *PRECIO:* $${this._formatPrice(alertData.price)} COP
📉 *Tu límite:* $${this._formatPrice(alertData.maxPrice)} COP
💸 *¡Ahorras:* $${(alertData.maxPrice - alertData.price).toLocaleString('es-CO')} COP

📅 *Fecha:* ${alertData.departureDate}
⏰ *Duración:* ${Math.floor(alertData.duration / 60)}h ${alertData.duration % 60}m
🛑 *Escalas:* ${alertData.stops === 0 ? 'Directo' : `${alertData.stops} escala(s)`}
💺 *Asientos disponibles:* ${alertData.availableSeats}

⚡ *¡RESERVA AHORA!* Los precios pueden cambiar rápidamente.

🎯 Esta es exactamente la oferta que estabas esperando. ¡No la dejes pasar!`;
  }

  /**
   * Mensaje de comandos disponibles
   */
  formatCommandsListMessage(): string {
    return `📝 *Lista Completa de Comandos*

*🔰 Básicos:*
• \`/start\` - Iniciar el bot
• \`/help\` - Ver ayuda

*✈️ Alertas:*
• \`/alert ORIGEN DESTINO PRECIO\` - Crear nueva alerta
• \`/myalerts\` - Ver mis alertas activas
• \`/stop ID\` - Pausar alerta específica
• \`/clearall\` - Eliminar todas las alertas

*🔍 Búsqueda:*
• \`/search ORIGEN DESTINO [FECHA]\` - Buscar vuelos

*👨‍💼 Admin:*
• \`/stats\` - Estadísticas del sistema

*Ejemplos Prácticos:*
\`/alert BOG MIA 850000\`
\`/alert MDE MAD 2500000\`
\`/search CTG LIM 2024-03-15\`
\`/stop 5\`

¿Dudas? ¡Escríbeme cualquier comando para ver cómo funciona!`;
  }

  /**
   * Guía de usuario
   */
  formatUserGuideMessage(): string {
    return `📖 *Guía de Usuario Completa*

*🚀 Cómo Empezar:*
1️⃣ Usa /start para registrarte
2️⃣ Crea tu primera alerta con /alert
3️⃣ ¡Recibe notificaciones automáticas!

*✈️ Creando Alertas Efectivas:*
• Usa códigos IATA de 3 letras (BOG, MIA, MAD)
• El precio debe ser realista para la ruta
• Puedes tener hasta 10 alertas activas
• El bot verifica precios cada 30 minutos

*💰 Consejos para Mejores Precios:*
• Crea alertas con precios 15-20% por debajo del promedio
• Los martes y miércoles suelen tener mejores ofertas
• Evita fechas festivas y temporadas altas
• Considera aeropuertos alternativos cercanos

*🔔 Notificaciones:*
• Recibes alertas instantáneas cuando hay ofertas
• El bot incluye link directo para reservar
• Puedes pausar alertas temporalmente

*🏙️ Aeropuertos Principales:*
*Colombia:* BOG, MDE, CTG, CLO, BAQ
*Internacional:* MIA, JFK, MAD, LIM, UIO

*🆘 Soporte:*
Si tienes problemas, usa /help o contacta al admin.

¡Felices viajes! 🌟`;
  }

  /**
   * Mensaje de estadísticas (admin)
   */
  formatStatsMessage(userStats: any, alertStats: any): string {
    return `📊 *Estadísticas del Sistema*

*👥 Usuarios:*
• Total: ${userStats.total}
• Activos: ${userStats.active}
• Nuevos hoy: ${userStats.newToday}
• Nuevos esta semana: ${userStats.newThisWeek}

*🚨 Alertas:*
• Total: ${alertStats.total}
• Activas: ${alertStats.active}
• Creadas hoy: ${alertStats.newToday}

*🔥 Rutas Populares:*
${alertStats.topRoutes.map((route: any, i: number) => 
  `${i + 1}. ${route.origin} → ${route.destination} (${route.count} alertas)`
).join('\n')}

*⚡ Sistema:*
• Estado: Operativo ✅
• Última actualización: ${new Date().toLocaleString('es-CO')}
• Uptime: ${process.uptime()} segundos`;
  }

  /**
   * Mensaje de error genérico
   */
  formatErrorMessage(): string {
    return `❌ *Oops! Algo salió mal*

Ocurrió un error inesperado. Por favor:

1️⃣ Intenta de nuevo en unos segundos
2️⃣ Verifica que el comando esté bien escrito
3️⃣ Si persiste, contacta al administrador

💡 Usa /help para ver los comandos disponibles.

¡Disculpa las molestias! 🙏`;
  }

  /**
   * Mensaje de rate limit
   */
  formatRateLimitMessage(): string {
    return `⚠️ *Demasiadas solicitudes*

Has enviado muchos comandos muy rápido. 

⏰ Espera un momento antes de enviar el siguiente comando.

Este límite ayuda a mantener el servicio estable para todos los usuarios.

¡Gracias por tu paciencia! 😊`;
  }

  /**
   * Mensaje de uso de comando /monthlyalert
   */
  formatMonthlyAlertUsageMessage(): string {
    return `❌ *Uso incorrecto del comando /monthlyalert*

*Formato correcto:*
\`/monthlyalert ORIGEN DESTINO PRECIO_MÁXIMO [MES]\`

*Ejemplos:*
• \`/monthlyalert SCL PUJ 800\` - Mes actual
• \`/monthlyalert SCL PUJ 800 02/2026\` - Febrero 2026
• \`/monthlyalert BOG MIA 300 marzo\` - Marzo (próximo)
• \`/monthlyalert LIM MAD 500 2026-04\` - Abril 2026

*Formatos de mes acepta:*
📅 **Números**: \`2\`, \`12\` (mes actual/próximo año)
📅 **Nombres**: \`febrero\`, \`mar\`, \`diciembre\`
📅 **MM/YYYY**: \`02/2026\`, \`12/2025\`
📅 **YYYY-MM**: \`2026-02\`, \`2025-12\`

*¿Qué es una alerta mensual?*
📅 Monitorea todo el mes en busca de ofertas
🤖 Análisis automático usando datos de Arajet
💰 Precios en USD (como aparecen en Arajet)
📊 Detecta días más baratos del mes
⏰ Válido hasta 12 meses adelante

*Códigos de aeropuertos soportados:*
🌎 SCL, PUJ, BOG, MIA, LIM, MAD, UIO, PTY y más...

💡 *Tip:* Si no especificas mes, usa el mes actual.`;
  }

  /**
   * Mensaje de alerta mensual creada exitosamente
   */
  formatMonthlyAlertCreatedMessage(alert: any): string {
    const originCode = alert.fromAirport || alert.origin;
    const destinationCode = alert.toAirport || alert.destination;
    const originAirport = airports[originCode as keyof typeof airports];
    const destinationAirport = airports[destinationCode as keyof typeof airports];

    // Formatear el mes para mostrar
    const monthYear = alert.searchMonth;
    const [year, month] = monthYear.split('-');
    const monthNames = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    const monthName = monthNames[parseInt(month) - 1];
    const formattedMonth = `${monthName} ${year}`;

    return `✅ *¡Alerta Mensual Creada!* 🗓️

🛫 *Ruta:* ${originAirport?.city || originCode} → ${destinationAirport?.city || destinationCode}
💰 *Precio máximo:* $${alert.maxPrice} USD
📅 *Mes objetivo:* ${formattedMonth}
👥 *Pasajeros:* 1 Adulto
🆔 *ID:* ${alert.id}

🤖 *Sistema Automático Arajet:*
• Analiza precios de todo el mes
• Detecta ofertas en tiempo real
• Identifica días más baratos
• Notificaciones instantáneas

⚡ *El monitoreo inteligente está activo*

Usa /myalerts para ver todas tus alertas activas.`;
  }

  /**
   * Formatear precio con separadores de miles
   */
  private _formatPrice(price: number): string {
    return price.toLocaleString('es-CO');
  }
}
